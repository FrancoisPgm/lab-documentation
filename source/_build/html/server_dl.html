

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Deep learning on a remote server &mdash; simexp-documentation 0.0.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> simexp-documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Deep learning on a remote server</a><ul>
<li><a class="reference internal" href="#pre-requisites">Pre-requisites</a></li>
<li><a class="reference internal" href="#what-will-you-learn">What will you learn ?</a></li>
<li><a class="reference internal" href="#why-using-containers">Why using containers ?</a></li>
<li><a class="reference internal" href="#hand-s-on">Hand’s on</a><ul>
<li><a class="reference internal" href="#upload-your-data-and-conncet-to-the-gpu-server">Upload your data and conncet to the GPU server</a></li>
<li><a class="reference internal" href="#launch-the-container">Launch the container</a></li>
<li><a class="reference internal" href="#work-on-the-notebook-remotely">Work on the notebook remotely</a></li>
</ul>
</li>
<li><a class="reference internal" href="#questions">Questions ?</a></li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">simexp-documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>Deep learning on a remote server</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/server_dl.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="deep-learning-on-a-remote-server">
<h1>Deep learning on a remote server<a class="headerlink" href="#deep-learning-on-a-remote-server" title="Permalink to this headline">¶</a></h1>
<p>You are probably in the case where you would like to use tensorflow on a remote server, to access the computation power from HPC.
It is now relatively easy to have a ready to use environment for your applications, specially for GPUs!</p>
<div class="section" id="pre-requisites">
<h2>Pre-requisites<a class="headerlink" href="#pre-requisites" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Basics use of Linux (cmd line, shell scripting, ssh)</p></li>
<li><p>Our <a class="reference external" href="https://github.com/SIMEXP/tutorials/blob/master/ssh_connection/Connect_with_ssh.md">ssh tutorial</a></p></li>
<li><p>Basic knowledge on containerized app (Docker, singularity)</p></li>
</ul>
</div>
<div class="section" id="what-will-you-learn">
<h2>What will you learn ?<a class="headerlink" href="#what-will-you-learn" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Use singularity container</p></li>
<li><p>Work on jupyter notebook for deep learning</p></li>
<li><p>Establish secure connection and port-forwarding from the server to your computer</p></li>
</ul>
</div>
<div class="section" id="why-using-containers">
<h2>Why using containers ?<a class="headerlink" href="#why-using-containers" title="Permalink to this headline">¶</a></h2>
<p>Container technology like <a class="reference external" href="https://www.docker.com/">Docker</a> is a major breakthrough in data science.
Indeed, it allows for <strong>reproducible</strong>, <strong>large-scale</strong> and <strong>burden-free environment setup</strong>.
In the mean-time, <a class="reference external" href="https://jupyter.org/">jupyter notebook</a> provides a portable <strong>interactive coding session</strong>, and is easy to use.</p>
</div>
<div class="section" id="hand-s-on">
<h2>Hand’s on<a class="headerlink" href="#hand-s-on" title="Permalink to this headline">¶</a></h2>
<p>Here, we will learn how to train a deep model on a remote server (could be CRIUGM, or computecanada)
using <a class="reference external" href="https://singularity.lbl.gov/">singularity</a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">singularity</span></code> containers are gaining a lot of popularity in the HPC world, because it is now easy as never to share reproducible
applications working smoothly on a remote server.</p>
</div>
<p>We are using <a class="reference external" href="https://www.cs.toronto.edu/~kriz/cifar.html">cifar10</a> dataset using a simple CNN containing an encoder with 4 layers,
and 3 dense layers.</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>

<span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">),</span> <span class="p">(</span><span class="n">x_test</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">cifar10</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">x_train</span><span class="p">,</span> <span class="n">x_test</span> <span class="o">=</span> <span class="n">x_train</span> <span class="o">/</span> <span class="mf">255.0</span><span class="p">,</span> <span class="n">x_test</span> <span class="o">/</span> <span class="mf">255.0</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">MaxPool2D</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">),</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">keras</span><span class="o">.</span><span class="n">losses</span><span class="o">.</span><span class="n">SparseCategoricalCrossentropy</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;adam&#39;</span><span class="p">,</span>
              <span class="n">loss</span><span class="o">=</span><span class="n">loss_fn</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;accuracy&#39;</span><span class="p">])</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">x_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">x_test</span><span class="p">,</span>  <span class="n">y_test</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<div class="section" id="upload-your-data-and-conncet-to-the-gpu-server">
<h3>Upload your data and conncet to the GPU server<a class="headerlink" href="#upload-your-data-and-conncet-to-the-gpu-server" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Create on your machine a jupyer notebook <code class="docutils literal notranslate"><span class="pre">mnist.ipynb</span></code> containing the previous code.</p></li>
<li><p>Upload the notebook on the server:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rsync -rlt --info<span class="o">=</span>progress2 mnist.ipynb &lt;user_name&gt;@meleze.criugm.qc.ca:~/
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We are using the server <code class="docutils literal notranslate"><span class="pre">meleze</span></code> which has a GTX 1070, of course you can choose any server you have access to.</p>
</div>
</div></blockquote>
</li>
</ol>
<ol class="arabic" start="2">
<li><p>Connect to <code class="docutils literal notranslate"><span class="pre">meleze</span></code></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh &lt;user_name&gt;@meleze
</pre></div>
</div>
</li>
</ol>
<p>We will launch this script using the container <a class="reference external" href="https://github.com/SIMEXP/deep-neuro-docker">deep-neuro-docker</a> available on github.
It is already installed on our server at <code class="docutils literal notranslate"><span class="pre">/data/cisl/CONTAINERS/deep-neuro-docker-gpu.simg</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <a class="reference external" href="https://github.com/SIMEXP/deep-neuro-docker">deep-neuro-docker</a> container is only compatible with
<a class="reference external" href="https://www.tensorflow.org/versions/r2.0/api_docs/python/tf">tensorflow 2.0</a> for both GPU and CPU.
Other software like <a class="reference external" href="https://pytorch.org/">pytorch</a> are also considered to be included in the future.</p>
</div>
</div>
<div class="section" id="launch-the-container">
<h3>Launch the container<a class="headerlink" href="#launch-the-container" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Load the singularity module to enable it,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>module load singularity
</pre></div>
</div>
</li>
<li><p>Run the tensorflow gpu container,</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>singularity <span class="nb">exec</span> --nv /data/cisl/CONTAINERS/deep-neuro-docker-gpu.simg jupyter notebook --notebook-dir<span class="o">=</span>~/ --no-browser --allow-root
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>CPU version is also available using the <code class="docutils literal notranslate"><span class="pre">deep-neuro-docker.simg</span></code> container.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>If you installed anaconda on your home folder, you will likely have some trouble because singularity image mounts by default your home to the container.
It then loads the library from the host instead of the libraries inside the container! To avoid this, use the following command instead:
<code class="code docutils literal notranslate"><span class="pre">singularity</span> <span class="pre">exec</span> <span class="pre">-B</span> <span class="pre">&lt;path/to/notebook&gt;:/notebooks</span> <span class="pre">--no-home</span> <span class="pre">deep-neuro-docker-gpu.simg</span> <span class="pre">jupyter</span> <span class="pre">notebook</span> <span class="pre">--notebook-dir=/notebooks</span> <span class="pre">--no-browser</span> <span class="pre">--allow-root</span></code></p>
</div>
</li>
</ol>
</div>
<div class="section" id="work-on-the-notebook-remotely">
<h3>Work on the notebook remotely<a class="headerlink" href="#work-on-the-notebook-remotely" title="Permalink to this headline">¶</a></h3>
<p>Create a ssh tunnel so you can work on your browser locally (even if it is running remotely):</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh -L <span class="m">6789</span>:localhost:&lt;server_port&gt; meleze
</pre></div>
</div>
<p>Where the output from jupyter on the remote server indicates what is the <code class="docutils literal notranslate"><span class="pre">&lt;server_port&gt;</span></code>, in this example it is <code class="docutils literal notranslate"><span class="pre">8889</span></code>:</p>
<a class="reference internal image-reference" href="_images/notebook_weblink.png"><img alt="_images/notebook_weblink.png" src="_images/notebook_weblink.png" style="width: 600px;" /></a>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Usually, when nobody uses a notebook server on the remote, the port will typically be <code class="docutils literal notranslate"><span class="pre">8888</span></code>.</p>
</div>
<p>Click on <a class="reference external" href="http://localhost:6789">http://localhost:6789</a>, to open the localhost on your browser from your machine.
You should have now access to the usual jupyter environment, launch <code class="docutils literal notranslate"><span class="pre">mnist.ipynb</span></code> to check that it is indeed using the GPU!</p>
</div>
</div>
<div class="section" id="questions">
<h2>Questions ?<a class="headerlink" href="#questions" title="Permalink to this headline">¶</a></h2>
<p>If you have any issues using jupyter notebooks, you can ask on the SIMEXP lab slack in <code class="docutils literal notranslate"><span class="pre">#python</span></code> channel!
For any other questions related to setup (containers) ask in #neuroinformatics.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, SIMEXP Pierre Bellec

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>